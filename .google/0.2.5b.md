# ‚õî **[OBSOLETE] v0.2.5b Specification ‚Äì MediaProjection (Failed)**

> **WARNING:** This specification describes a **FAILED** implementation strategy using `MediaProjection`.
> The AYN Thor hardware mirrors the main display when using `MediaProjection` for the secondary display, making this approach impossible.
>
> **DO NOT IMPLEMENT THIS.**
>
> Refer to **v0.2.5c.md** for the correct Root/Shizuku-based implementation.

---

# üìÑ **[ORIGINAL TEXT PRESERVED BELOW FOR HISTORICAL CONTEXT]**

**Version:** 0.2.5b
**Scope:** Introduce the Dual Screenshot feature triggered from Mjolnir‚Äôs persistent notification.
**Supersedes:** In case of conflicting specs, this document takes priority over 0.2.5.md (0.2.5a was KDoc-only and unrelated).
**Non-Goals:** No UI refactoring, no fallback capture methods, no notification customization beyond what is defined here.

---

# 1. **Overview**

v0.2.5b adds internal support for capturing both physical displays of the AYN Thor and combining them into a single vertically aligned PNG called a **DualShot**. The operation is initiated through a new button inside the persistent Mjolnir notification.

The system performs:

1. Notification shade collapse
2. Small delay for UI to clear
3. Concurrent screen capture of Top and Bottom displays
4. Stitching into a single PNG (transparent background)
5. Saving to the Android system Screenshots directory
6. Posting a screenshot-style notification with Open / Share / Delete actions

All work except final notification dispatch runs on a background thread.

---

# 2. **Trigger Mechanism**

Add a new action button to the persistent Mjolnir notification:

* **Label:** ‚ÄúDual Screenshot‚Äù
* **Action Intent:** `ACTION_DUAL_SCREENSHOT`

When tapped, the service owning the persistent notification must:

```
DualScreenshotManager.start(context)
```

No additional foreground session is created; the existing service handles the action.

---

# 3. **Notification Shade Dismissal**

Before capturing displays:

1. Collapse the notification shade (using the simplest functional approach; AccessibilityService is permitted if required).
2. Wait a short, configurable delay on a background thread.

### Default delay:

```
500 ms
```

The delay exists to ensure the shade and system UI elements fully disappear before capture.

This delay is **not user-configurable** (internal parameter only).

---

# 4. **DualScreenshotManager**

A new manager under:

```
xyz.blacksheep.mjolnir.utils
```

Primary entry point:

```kotlin
fun start(context: Context)
```

This manager is responsible for coordinating:

* Notification shade collapse
* Capture delay
* Concurrent capture of top and bottom displays
* Stitching into a single image
* Saving to MediaStore‚Äôs Screenshots folder
* Displaying the final screenshot notification

---

# 5. **Capture Pipeline**

## 5.1 Goals

* Capture **Top display bitmap**
* Capture **Bottom display bitmap**
* Initiate both captures **simultaneously**
* No sequential dependency

## 5.2 Concurrency Requirements

Top and bottom capture must start concurrently:

* Launch both operations with async/parallel execution on a background dispatcher.
* Await both results before stitching.

## 5.3 Threading

**All capture operations must run on a background thread.**

Use:

* `Dispatchers.IO`, or
* A similar background executor

Only notification publishing returns to the main thread.

## 5.4 Capture Implementation Notes

The spec **does not mandate** a particular API.
Mjolnir is free to use MediaProjection or another internal method.

The requirement is simply:

```
captureTop(): Bitmap
captureBottom(): Bitmap
```

If a capture fails:

* Log via DiagnosticsLogger (if enabled)
* Show a toast
* Abort stitching and notification posting

---

# 6. **Stitching Specification**

Define a stitching method:

```kotlin
fun stitch(top: Bitmap, bottom: Bitmap): Bitmap
```

### Output Canvas:

* Width = `max(top.width, bottom.width)`
* Height = `top.height + bottom.height`
* Format = `ARGB_8888`
* Background = Fully transparent

### Placement:

* Top screen centered at `(x = centered, y = 0)`
* Bottom screen centered at `(x = centered, y = top.height)`

Center formula:

```
centerX = (canvasWidth - screen.width) / 2
```

### Decoration Hooks (no-ops)

Provide placeholder functions with pass-through behavior:

```
addBorders()
addSpacing()
addBackground()
```

These do nothing in v0.2.5b.

---

# 7. **Saving the Final Image**

The stitched bitmap is saved as a PNG with full alpha support.

## 7.1 Destination

Save to the official Android Screenshot directory using MediaStore:

```
Pictures/Screenshots/
```

This ensures the image:

* Is visible in Gallery apps immediately
* Is inserted into the system media index
* Behaves like a standard screenshot

## 7.2 File Naming

Use:

```
DualShot_<timestamp>.png
```

Timestamp format:

```
yyyyMMdd_HHmmss
```

Example:

```
DualShot_20250209_153822.png
```

## 7.3 Visibility in Gallery

File must be inserted with:

* MIME type: `image/png`
* Relative path: `Pictures/Screenshots/`

---

# 8. **Delete Behavior**

The screenshot notification includes a **Delete** action.

Deletion must:

1. Remove the file itself
2. Remove its MediaStore entry
3. Dismiss the screenshot notification

The persistent service notification must not be affected.

---

# 9. **Screenshot Notification (Result Notification)**

After saving the PNG, post a notification using the following channel:

* **Channel ID:** `mjolnir_dualshot`
* **Channel Name:** `Dual Screenshots`
* **Importance:** `DEFAULT`

### Notification Must Provide:

* BigPicture preview of the captured dual screenshot
* Tap-to-open behavior (`ACTION_VIEW`)
* **Share** action (standard share intent)
* **Delete** action
* Auto-clears when opened
* Must NOT clear or modify the persistent Mjolnir notification

Notifications must be posted on the main thread.

---

# 10. **Failure UI**

If dual screenshot capture fails at any step:

* Show a toast:
  **‚ÄúDual Screenshot Failed‚Äù**
* Log the error with DiagnosticsLogger *only if diagnostics are enabled*
* No result notification is posted

---

# 11. **Performance Requirements**

* Never block main/UI thread during capture, stitch, or save
* Recycle or release bitmap memory when safe
* Avoid ANRs or freezes during intensive operations
* Minimize latency from button press to result notification

---

# 12. **File Organization**

The manager must be added to:

```
xyz.blacksheep.mjolnir.utils
```

(Your future refactor may merge `/services/` and `/utils/`, but that is outside the scope of v0.2.5b.)

---

# ‚úîÔ∏è **v0.2.5b Specification Complete**

This is the final, authoritative implementation specification for the Dual Screenshot feature.
It contains no assumptions, no fallback systems, and nothing outside the boundaries you defined.

If you'd like, I can now:

### ‚úì Generate the Kotlin skeleton for `DualScreenshotManager`

### ‚úì Draft the new notification action for KeepAliveService

### ‚úì Produce a checklist for Gemini to code against

### ‚úì Build a debugging plan for MediaProjection capture

Just tell me what you want next.
