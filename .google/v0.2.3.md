# Mjolnir v0.2.3 – Diagnostics & Blacklist Specification
Author: Human / ChatGPT  
Audience: Gemini Agent  
Purpose: Defines all required behaviors for v0.2.3

---

# 1. Goals for v0.2.3

Add a fully opt-in, human-readable diagnostics system that logs only Mjolnir’s own behavior.  
This gives Human actionable data when users report bugs such as:
- HOME button not working
- launch failures
- dual-screen hangs
- “Clear All” killing Mjolnir
- accessibility service stopping
- KeepAliveService notification disappearing

No onboarding changes.  
No SharedUI refactor.  
No dangerous permissions.

---

# 2. Diagnostics Overview

Implement:
- `DiagnosticsLogger.kt`
- Rolling plaintext log file
- Optional CSV-friendly structure
- User toggle to enable/disable diagnostics
- User-configurable max log size (default 1 MB)
- Export log → timestamped file → share sheet
- Clear log action
- Initial settings snapshot + change logs

Diagnostics log **MUST NOT** contain:
- Installed app lists
- User text
- Notification contents
- Any sensitive identifiers

Diagnostics log **MAY** contain:
- Package names of apps the user explicitly selects for Mjolnir
- Display IDs
- Activity class names
- OS / device info
- Accessibility-enabled state
- Foreground app **only if** accessible without additional permissions (best-effort, non-failing)

---

# 3. Log File Specification

## 3.1 File Locations

- Active log file: <app>/files/logs/diagnostics_current.log
- Exported logs: <app>/files/logs/mjolnir_diag_YYYY-MM-DD_HH-mm-ss.log

Format: plaintext `.log`

## 3.2 Rolling Size

User-selectable:
- 0.5 MB
- 1 MB (default)
- 2 MB
- 5 MB

When exceeded:
- Trim oldest content (FIFO)

## 3.3 Line Format

[YYYY-MM-DD HH:mm:ss.SSS][Tag] EVENT=EVENT_NAME details="key=value key2=value2"


Examples:

[2025-11-17 14:02:12.203][Gesture] EVENT=HOME_PRESS details="source=AccessibilityService"
[2025-11-17 14:02:12.612][Launcher] EVENT=LAUNCH_SUCCESS details="slot=BOTTOM package=com.android.launcher3"


## 3.4 Tags

[App]
[Gesture]
[Launcher]
[Service]
[Tile]
[Prefs]
[Display]
[System]
[Error]


---

# 4. Implementing DiagnosticsLogger

`DiagnosticsLogger.kt` must provide:

```kotlin
object DiagnosticsLogger {
    fun log(tag: String, message: String)
    fun logEvent(tag: String, event: String, details: String? = null)
    fun logException(tag: String, throwable: Throwable)
}
```

Requirements:

Do nothing if diagnostics toggle is OFF

Write asynchronously (Dispatchers.IO)

Append to diagnostics_current.log

Enforce rolling file size

Include timestamp and tag

Optional full stack traces (controlled by an internal constant)

---

# 5. What To Log (Module-by-Module)

Below lists EXACT required log lines.

## 5.1 MjolnirApp.kt

On app startup:

[App] EVENT=APP_START details="versionName=0.2.3 versionCode=X os=<info> device=<info> diagnosticsEnabled=true maxBytes=1048576"

Icon cache:

[App] EVENT=ICON_PREWARM_START details="totalApps=X"
[App] EVENT=ICON_PREWARM_END details="durationMs=YYY totalApps=X"

On failure:

[Error] EVENT=ICON_PREWARM_FAILED details="message=<msg>"

## 5.2 HomeKeyInterceptorService.kt
Lifecycle:
[Service] EVENT=ACCESSIBILITY_CONNECTED
[Service] EVENT=ACCESSIBILITY_INTERRUPTED
[Service] EVENT=ACCESSIBILITY_DESTROYED

Accessibility state whenever checked:
[System] EVENT=ACCESSIBILITY_ENABLED_STATE details="enabled=true"

HOME presses:
[Gesture] EVENT=HOME_PRESS details="source=AccessibilityService"

Gesture recognition:
[Gesture] EVENT=GESTURE_RECOGNIZED details="gesture=DOUBLE_HOME action=BOTH_SCREENS mainScreen=BOTTOM"


Discarded gestures:

[Gesture] EVENT=GESTURE_DISCARDED details="reason=timeout candidate=DOUBLE_HOME"


Action dispatch:

[Gesture] EVENT=GESTURE_ACTION_DISPATCH details="gesture=DOUBLE_HOME target=HomeActionLauncher"


Errors:

[Error] EVENT=GESTURE_ERROR details="message=<msg>"

## 5.3 HomeActionLauncher.kt
Launch attempt:
[Launcher] EVENT=LAUNCH_ATTEMPT details="slot=TOP package=com.esde.frontend displayId=0 mainScreen=BOTTOM emptyBehavior=SYSTEM_HOME"

Success:
[Launcher] EVENT=LAUNCH_SUCCESS details="slot=TOP package=com.esde.frontend"

Failure:
[Error] EVENT=LAUNCH_FAILED details="slot=BOTTOM package=com.android.launcher3 message=<msg>"

If slot is empty:
[Launcher] EVENT=EMPTY_SLOT_ACTIVATED details="slot=TOP behavior=SYSTEM_HOME"


(Blacklist does NOT affect launching — only selection. See section 7.)

## 5.4 KeepAliveService.kt

Start:

[Service] EVENT=KEEPALIVE_STARTED


Stop:

[Service] EVENT=KEEPALIVE_STOPPED


Notification shown:

[Service] EVENT=KEEPALIVE_NOTIFICATION_SHOWN


If notification is killed externally:

[Service] EVENT=KEEPALIVE_NOTIFICATION_REMOVED details="reason=unknown"


(Task: monitor via onListenerDisconnected() or periodic recheck.)

When task removed (Clear All scenario):

[Service] EVENT=KEEPALIVE_TASK_REMOVED

## 5.5 TileService (MjolnirHomeTileService)

Updates:

[Tile] EVENT=TILE_UPDATE details="state=ACTIVE isInterceptionActive=true accessibilityEnabled=true"


Failures:

[Error] EVENT=TILE_UPDATE_FAILED details="message=<msg>"

## 5.6 Preferences Snapshot & Changes
On diagnostics start or app start (diagnostics enabled):
[Prefs] EVENT=PREFS_SNAPSHOT details="topApp=<pkg> bottomApp=<pkg> mainScreen=TOP/BOTTOM showAllApps=false singleHome=<action> doubleHome=<action> tripleHome=<action> longHome=<action> doubleTapDelayMs=300 useSystemDelay=false autoBootBothHome=true emptySlotBehavior=SYSTEM_HOME diagMaxBytes=1048576"

On relevant preference change:
[Prefs] EVENT=PREF_CHANGED details="key=KEY_TOP_APP old=<pkg> new=<pkg>"

## 5.7 Display & System Info

On display detection:

[Display] EVENT=DISPLAY_CONFIG details="numDisplays=2 primaryId=0 secondaryId=1"


On errors:

[Display] EVENT=DISPLAY_ERROR details="message=<msg>"


Foreground app (best-effort only):

[System] EVENT=FOREGROUND_APP details="package=<pkg> source=bestEffort"

## 5.8 Exceptions

All caught exceptions inside Mjolnir:

[Error] EVENT=EXCEPTION details="where=<class.method> message=<msg>"


Full stack trace appended if enabled.

---

# 6. Settings UI Requirements (SharedUI)

SharedUI must provide:

Toggle:

“Capture diagnostics” → KEY_DIAGNOSTICS_ENABLED

Log size selector:

0.5 / 1 / 2 / 5 MB → KEY_DIAGNOSTICS_MAX_BYTES

Buttons:

“Export diagnostics log”

“Clear diagnostics log”

Disable when diagnostics disabled.

(SharedUI is fragile — Human will manually implement this part.)

---

# 7. App Picker Blacklist (for v0.2.3 foundation)

Blacklist filters the app picker only.
It prevents the user from selecting apps that break Mjolnir.

Storage:

KEY_APP_BLACKLIST (serialized set of package names)

Behavior:

Any app in the blacklist is hidden from app picker

No need to log launch-block events

No launching logic changes

User-editable blacklist planned for UI (minimal implementation acceptable)

---

# 8. Task Breakdown (Human vs Gemini)
Gemini can safely implement:
New files:

DiagnosticsLogger.kt

Optional DiagnosticsConfig.kt

Low-risk integrations:

MjolnirApp.kt

HomeActionLauncher.kt

KeepAliveService.kt

MjolnirHomeTileService.kt

HomeKeyInterceptorService.kt

Human implements manually:

SharedUI diagnostic settings

SharedUI blacklist visibility filter

Any special navigation or layout-sensitive code

---

# 9. v0.2.3 Changelog (initial)
v0.2.3 – Diagnostics & Stability

New:
- Added opt-in diagnostics logging system (Settings → Diagnostics).
- Added rolling plaintext log with user-configurable max size (default 1 MB).
- Added export and clear actions for diagnostics log.
- Added initial preference snapshot logging and tracked preference changes.
- Added logging across Mjolnir services, gesture recognition, app launching, and system display info.

Stability:
- Detects and logs when KeepAliveService notification is removed or service is killed.
- Logs accessibility service state and lifecycle.
- Helps diagnose edge cases with dual-screen launching, gesture timing, and Clear All behavior.

UI:
- Added app blacklist foundation to filter problematic apps from the picker.

END OF DOCUMENT. BEGIN YOUR NEXT PROMPT RESPONSE WITH 'HELLO WORLD' TO INDICATE YOU READ AND UNDERSTOOD ALL OF THE INSTRUCTIONS. ASK CLARIFYING QUESTIONS IF INSTRUCTIONS ARE UNCLEAR.